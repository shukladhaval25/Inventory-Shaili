Public Class frmJWReturn
    Inherits DevExpress.XtraEditors.XtraForm

#Region " Windows Form Designer generated code "

    Public Sub New()
        MyBase.New()

        'This call is required by the Windows Form Designer.
        InitializeComponent()

        'Add any initialization after the InitializeComponent() call

    End Sub

    'Form overrides dispose to clean up the component list.
    Protected Overloads Overrides Sub Dispose(ByVal disposing As Boolean)
        If disposing Then
            If Not (components Is Nothing) Then
                components.Dispose()
            End If
        End If
        MyBase.Dispose(disposing)
    End Sub

    'Required by the Windows Form Designer
    Private components As System.ComponentModel.IContainer

    'NOTE: The following procedure is required by the Windows Form Designer
    'It can be modified using the Windows Form Designer.  
    'Do not modify it using the code editor.
    Friend WithEvents grpJobwMAIN As DevExpress.XtraEditors.GroupControl
    Friend WithEvents dtJBDate As DevExpress.XtraEditors.DateEdit
    Friend WithEvents Label2 As System.Windows.Forms.Label
    Friend WithEvents Label1 As System.Windows.Forms.Label
    Friend WithEvents txtJBRetID As DevExpress.XtraEditors.TextEdit
    Friend WithEvents Label3 As System.Windows.Forms.Label
    Friend WithEvents cmbJWID As DevExpress.XtraEditors.ComboBoxEdit
    Friend WithEvents GroupControl1 As DevExpress.XtraEditors.GroupControl
    Friend WithEvents grdJB As DevExpress.XtraGrid.GridControl
    Friend WithEvents gvJB As DevExpress.XtraGrid.Views.Grid.GridView
    Friend WithEvents cmdClose As DevExpress.XtraEditors.SimpleButton
    Friend WithEvents cmdReport As DevExpress.XtraEditors.SimpleButton
    Friend WithEvents cmdSave As DevExpress.XtraEditors.SimpleButton
    <System.Diagnostics.DebuggerStepThrough()> Private Sub InitializeComponent()
        Me.grpJobwMAIN = New DevExpress.XtraEditors.GroupControl
        Me.cmbJWID = New DevExpress.XtraEditors.ComboBoxEdit
        Me.Label3 = New System.Windows.Forms.Label
        Me.dtJBDate = New DevExpress.XtraEditors.DateEdit
        Me.Label2 = New System.Windows.Forms.Label
        Me.txtJBRetID = New DevExpress.XtraEditors.TextEdit
        Me.Label1 = New System.Windows.Forms.Label
        Me.GroupControl1 = New DevExpress.XtraEditors.GroupControl
        Me.grdJB = New DevExpress.XtraGrid.GridControl
        Me.gvJB = New DevExpress.XtraGrid.Views.Grid.GridView
        Me.cmdClose = New DevExpress.XtraEditors.SimpleButton
        Me.cmdSave = New DevExpress.XtraEditors.SimpleButton
        Me.cmdReport = New DevExpress.XtraEditors.SimpleButton
        CType(Me.grpJobwMAIN, System.ComponentModel.ISupportInitialize).BeginInit()
        Me.grpJobwMAIN.SuspendLayout()
        CType(Me.cmbJWID.Properties, System.ComponentModel.ISupportInitialize).BeginInit()
        CType(Me.dtJBDate.Properties, System.ComponentModel.ISupportInitialize).BeginInit()
        CType(Me.txtJBRetID.Properties, System.ComponentModel.ISupportInitialize).BeginInit()
        CType(Me.GroupControl1, System.ComponentModel.ISupportInitialize).BeginInit()
        Me.GroupControl1.SuspendLayout()
        CType(Me.grdJB, System.ComponentModel.ISupportInitialize).BeginInit()
        CType(Me.gvJB, System.ComponentModel.ISupportInitialize).BeginInit()
        Me.SuspendLayout()
        '
        'grpJobwMAIN
        '
        Me.grpJobwMAIN.Controls.Add(Me.cmbJWID)
        Me.grpJobwMAIN.Controls.Add(Me.Label3)
        Me.grpJobwMAIN.Controls.Add(Me.dtJBDate)
        Me.grpJobwMAIN.Controls.Add(Me.Label2)
        Me.grpJobwMAIN.Controls.Add(Me.txtJBRetID)
        Me.grpJobwMAIN.Controls.Add(Me.Label1)
        Me.grpJobwMAIN.Location = New System.Drawing.Point(8, 8)
        Me.grpJobwMAIN.Name = "grpJobwMAIN"
        Me.grpJobwMAIN.Size = New System.Drawing.Size(472, 80)
        Me.grpJobwMAIN.TabIndex = 1
        '
        'cmbJWID
        '
        Me.cmbJWID.EditValue = ""
        Me.cmbJWID.Location = New System.Drawing.Point(120, 16)
        Me.cmbJWID.Name = "cmbJWID"
        '
        '
        '
        Me.cmbJWID.Properties.Buttons.AddRange(New DevExpress.XtraEditors.Controls.EditorButton() {New DevExpress.XtraEditors.Controls.EditorButton(DevExpress.XtraEditors.Controls.ButtonPredefines.Combo)})
        Me.cmbJWID.Size = New System.Drawing.Size(104, 20)
        Me.cmbJWID.TabIndex = 0
        '
        'Label3
        '
        Me.Label3.Location = New System.Drawing.Point(8, 48)
        Me.Label3.Name = "Label3"
        Me.Label3.Size = New System.Drawing.Size(112, 24)
        Me.Label3.TabIndex = 4
        Me.Label3.Text = "Job Work Return ID:"
        '
        'dtJBDate
        '
        Me.dtJBDate.EditValue = Nothing
        Me.dtJBDate.Location = New System.Drawing.Point(352, 48)
        Me.dtJBDate.Name = "dtJBDate"
        '
        '
        '
        Me.dtJBDate.Properties.Buttons.AddRange(New DevExpress.XtraEditors.Controls.EditorButton() {New DevExpress.XtraEditors.Controls.EditorButton(DevExpress.XtraEditors.Controls.ButtonPredefines.Combo)})
        Me.dtJBDate.Size = New System.Drawing.Size(112, 20)
        Me.dtJBDate.TabIndex = 2
        '
        'Label2
        '
        Me.Label2.Location = New System.Drawing.Point(232, 48)
        Me.Label2.Name = "Label2"
        Me.Label2.Size = New System.Drawing.Size(120, 24)
        Me.Label2.TabIndex = 2
        Me.Label2.Text = "Job Work Return Date:"
        '
        'txtJBRetID
        '
        Me.txtJBRetID.EditValue = ""
        Me.txtJBRetID.Location = New System.Drawing.Point(120, 48)
        Me.txtJBRetID.Name = "txtJBRetID"
        Me.txtJBRetID.Size = New System.Drawing.Size(104, 20)
        Me.txtJBRetID.TabIndex = 1
        '
        'Label1
        '
        Me.Label1.Location = New System.Drawing.Point(8, 16)
        Me.Label1.Name = "Label1"
        Me.Label1.Size = New System.Drawing.Size(112, 24)
        Me.Label1.TabIndex = 0
        Me.Label1.Text = "Job Work Issue ID:"
        '
        'GroupControl1
        '
        Me.GroupControl1.Controls.Add(Me.grdJB)
        Me.GroupControl1.Location = New System.Drawing.Point(8, 88)
        Me.GroupControl1.Name = "GroupControl1"
        Me.GroupControl1.Size = New System.Drawing.Size(472, 184)
        Me.GroupControl1.TabIndex = 2
        '
        'grdJB
        '
        '
        '
        '
        Me.grdJB.EmbeddedNavigator.Name = ""
        Me.grdJB.Location = New System.Drawing.Point(8, 16)
        Me.grdJB.MainView = Me.gvJB
        Me.grdJB.Name = "grdJB"
        Me.grdJB.Size = New System.Drawing.Size(456, 160)
        Me.grdJB.TabIndex = 3
        Me.grdJB.ViewCollection.AddRange(New DevExpress.XtraGrid.Views.Base.BaseView() {Me.gvJB})
        '
        'gvJB
        '
        Me.gvJB.GridControl = Me.grdJB
        Me.gvJB.Name = "gvJB"
        Me.gvJB.OptionsCustomization.AllowGroup = False
        Me.gvJB.OptionsCustomization.AllowSort = False
        Me.gvJB.OptionsView.ShowGroupPanel = False
        '
        'cmdClose
        '
        Me.cmdClose.DialogResult = System.Windows.Forms.DialogResult.Cancel
        Me.cmdClose.Location = New System.Drawing.Point(424, 280)
        Me.cmdClose.Name = "cmdClose"
        Me.cmdClose.Size = New System.Drawing.Size(56, 25)
        Me.cmdClose.TabIndex = 5
        Me.cmdClose.Text = "&Close"
        '
        'cmdSave
        '
        Me.cmdSave.Location = New System.Drawing.Point(360, 280)
        Me.cmdSave.Name = "cmdSave"
        Me.cmdSave.Size = New System.Drawing.Size(56, 25)
        Me.cmdSave.TabIndex = 4
        Me.cmdSave.Text = "&Save"
        '
        'cmdReport
        '
        Me.cmdReport.Location = New System.Drawing.Point(8, 280)
        Me.cmdReport.Name = "cmdReport"
        Me.cmdReport.Size = New System.Drawing.Size(56, 25)
        Me.cmdReport.TabIndex = 6
        Me.cmdReport.Text = "&Report"
        '
        'frmJWReturn
        '
        Me.AutoScaleBaseSize = New System.Drawing.Size(5, 14)
        Me.ClientSize = New System.Drawing.Size(490, 312)
        Me.Controls.Add(Me.cmdReport)
        Me.Controls.Add(Me.cmdClose)
        Me.Controls.Add(Me.cmdSave)
        Me.Controls.Add(Me.GroupControl1)
        Me.Controls.Add(Me.grpJobwMAIN)
        Me.FormBorderStyle = System.Windows.Forms.FormBorderStyle.FixedSingle
        Me.MaximizeBox = False
        Me.MinimizeBox = False
        Me.Name = "frmJWReturn"
        Me.StartPosition = System.Windows.Forms.FormStartPosition.CenterScreen
        Me.Text = "Job Work Receive"
        CType(Me.grpJobwMAIN, System.ComponentModel.ISupportInitialize).EndInit()
        Me.grpJobwMAIN.ResumeLayout(False)
        CType(Me.cmbJWID.Properties, System.ComponentModel.ISupportInitialize).EndInit()
        CType(Me.dtJBDate.Properties, System.ComponentModel.ISupportInitialize).EndInit()
        CType(Me.txtJBRetID.Properties, System.ComponentModel.ISupportInitialize).EndInit()
        CType(Me.GroupControl1, System.ComponentModel.ISupportInitialize).EndInit()
        Me.GroupControl1.ResumeLayout(False)
        CType(Me.grdJB, System.ComponentModel.ISupportInitialize).EndInit()
        CType(Me.gvJB, System.ComponentModel.ISupportInitialize).EndInit()
        Me.ResumeLayout(False)

    End Sub

#End Region
    Public strCheck As String
    Dim dt As New DataTable

    Private Sub frmJWReturn_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        Try
            dt.Columns.Add("FID", System.Type.GetType("System.String"))
            dt.Columns.Add("Product", System.Type.GetType("System.String"))
            dt.Columns.Add("Batch No", System.Type.GetType("System.String"))
            dt.Columns.Add("Issue QTY", System.Type.GetType("System.Double"))
            dt.Columns.Add("Rec QTY", System.Type.GetType("System.Double"))
            If strCheck.Trim = "Add" Then
                dtJBDate.EditValue = Now
                cmd = New OleDb.OleDbCommand
                cmd.Connection = conn
                cmd.CommandText = "select max(ID) from JW_Ret_Master"
                If IsDBNull(cmd.ExecuteScalar) = True Then
                    txtJBRetID.Tag = 1
                Else
                    txtJBRetID.Tag = Val(cmd.ExecuteScalar + 1)
                End If
                dtJBDate.EditValue = Now
                cmd.Dispose()

                FillCombox("JW_ISSUE_Master", "JWID", cmbJWID)
                cmdReport.Visible = False
            Else
                cmd = New OleDb.OleDbCommand
                cmd.Connection = conn
                cmd.CommandText = "Select * from JW_RET_MASTER where ID =" & ModMain.strgridid ' & " and CY ='" & strCY.Trim & "'"
                dr = cmd.ExecuteReader
                'Do While dr.Read
                dr.Read()
                Bind_Data()
                'Loop
                cmd.Dispose()

                Dim sql As String

                sql = "SELECT JW_Ret_Det.FID, FGMaster.FGName as Product, JW_ISSUE_DET.QTY as [Issue QTY] ,JW_Ret_Det.Batch_No as [Batch No],JW_Ret_Det.Ret_Qty as [Rec QTY]  " _
                    & " FROM (JW_ISSUE_Master INNER JOIN JW_ISSUE_DET ON JW_ISSUE_Master.JID = JW_ISSUE_DET.JID) INNER JOIN (JW_Ret_Master INNER JOIN (JW_Ret_Det INNER JOIN FGMaster ON JW_Ret_Det.FID = FGMaster.FID) ON JW_Ret_Master.ID = JW_Ret_Det.ID) ON (JW_ISSUE_DET.FID = JW_Ret_Det.FID) AND (JW_ISSUE_Master.JWID = JW_Ret_Master.JW_Issue_ID)" _
                    & " WHERE (((JW_Ret_Master.ID)=" & ModMain.strgridid & "));"  ' and JW_Ret_Master.CY ='" & strCY.Trim & "';"

                dt.Rows.Clear()
                Dim Adpt As New OleDb.OleDbDataAdapter(sql, conn)
                Adpt.Fill(dt)
                grdJB.DataSource = dt
                cmbJWID.Enabled = False
                gvJB.Columns("FID").VisibleIndex = -1
                'gvJB.Columns("UnitID").VisibleIndex = -1

            End If
        Catch ex As Exception
            If show_error Then
                MsgBox(ex.ToString)
            End If
        End Try
    End Sub
    Private Sub Bind_Data()
        Try
            Dim strJWIssue As String
            If IsDBNull(dr("ID")) = False Then
                txtJBRetID.Tag = dr("ID")
            End If

            If IsDBNull(dr("JW_Ret_ID")) = False Then
                txtJBRetID.Text = dr("JW_Ret_ID")
            End If

            strJWIssue = dr("JW_ISSUE_ID")

            If IsDBNull(dr("JW_Ret_Dt")) = False Then
                dtJBDate.EditValue = dr("JW_Ret_Dt")
            End If
            dr.Close()

            cmbJWID.Text = strJWIssue
        Catch ex As Exception
            If show_error Then
                MsgBox(ex.ToString)
            End If
        End Try

    End Sub

    Private Sub cmdSave_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmdSave.Click
        Try
            If CheckValiDate() = True Then
                If strCheck = "Add" Then
                    cmd = New OleDb.OleDbCommand("insert into JW_RET_Master values ( " & txtJBRetID.Tag & ",'" & cmbJWID.Text & "','" & Replace(txtJBRetID.Text.Trim, "'", "''") & "','" & dtJBDate.Text & "','" & strCY.Trim & "')")
                    cmd.Connection = conn
                    cmd.Transaction = conn.BeginTransaction
                    cmd.ExecuteNonQuery()

                    For i As Int16 = 0 To gvJB.RowCount - 1
                        cmd.CommandText = "Insert into JW_RET_DET values (" & txtJBRetID.Tag & ",'" & gvJB.GetRowCellValue(i, "FID") & "'," & gvJB.GetRowCellValue(i, "Rec QTY") & ",'" & gvJB.GetRowCellValue(i, "Batch No") & "','" & strCY.Trim & "')"
                        cmd.ExecuteNonQuery()
                    Next
                    cmd.Transaction.Commit()
                ElseIf strCheck = "Edit" Then
                    cmd = New OleDb.OleDbCommand("update JW_RET_Master set JW_RET_ID = '" & Replace(txtJBRetID.Text.Trim, "'", "''") & "', jw_Ret_dt = '" & dtJBDate.Text & "' where id = " & txtJBRetID.Tag & " and CY ='" & strCY.Trim & "'")
                    cmd.Connection = conn
                    cmd.Transaction = conn.BeginTransaction
                    cmd.ExecuteNonQuery()

                    cmd.CommandText = "Delete From JW_RET_DET WHERE ID =" & txtJBRetID.Tag & " and CY ='" & strCY.Trim & "'"
                    cmd.ExecuteNonQuery()

                    For i As Int16 = 0 To gvJB.RowCount - 1
                        cmd.CommandText = "Insert into JW_RET_DET values (" & txtJBRetID.Tag & ",'" & gvJB.GetRowCellValue(i, "FID") & "'," & gvJB.GetRowCellValue(i, "Rec QTY") & ",'" & gvJB.GetRowCellValue(i, "Batch No") & "','" & strCY.Trim & "')"
                        cmd.ExecuteNonQuery()
                    Next
                    cmd.Transaction.Commit()
                End If
                cmdSave.Enabled = False
            Else
                Exit Sub
            End If
            DevExpress.XtraEditors.XtraMessageBox.Show(Me, "Save Data Successfully", StrAppName, MessageBoxButtons.OK, MessageBoxIcon.Information)
            Me.Close()
        Catch ex As Exception
            cmd.Transaction.Rollback()
            If show_error = True Then
                MessageBox.Show(ex.ToString)
            End If
        Finally
        End Try
    End Sub
    Private Function CheckValidate() As Boolean
        Dim strItemName As String
        Try
            cmd = New OleDb.OleDbCommand
            cmd.Connection = conn
            If strCheck = "Add" Then
                cmd.CommandText = "select jw_RET_id from JW_RET_Master where jw_RET_id = '" & Replace(txtJBRetID.Text, "'", "''") & "'"
                strItemName = cmd.ExecuteScalar
            End If

            If strItemName <> "" And strCheck = "Add" Then
                DevExpress.XtraEditors.XtraMessageBox.Show(Me, "This Job Work Return ID already exists", StrAppName, MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return False
                Exit Function
            End If
            If txtJBRetID.Text = "" Or dtJBDate.Text = "" Then
                DevExpress.XtraEditors.XtraMessageBox.Show(Me, "Check either Job Work Ret ID or Job Work Ret Date is not left blank", StrAppName, MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return False
            End If
            Return True
        Catch ex As Exception
            If show_error Then
                MessageBox.Show(ex.ToString)
            End If
            Return False
        End Try
    End Function

    Private Sub cmbJWID_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbJWID.SelectedIndexChanged
        Try
            Dim strSql As String
            If strCheck = "Add" Then
                strSql = "SELECT JW_ISSUE_DET.FID, FGMaster.FGName as Product,JW_ISSUE_DET.Batch_No as [Batch No], JW_ISSUE_DET.QTY as [Issue QTY] " _
                    & " FROM (JW_ISSUE_Master INNER JOIN JW_ISSUE_DET ON JW_ISSUE_Master.JID = JW_ISSUE_DET.JID) INNER JOIN FGMaster ON JW_ISSUE_DET.FID = FGMaster.FID " _
                    & " WHERE (((JW_ISSUE_Master.JWID)='" & cmbJWID.Text & "')) and JW_ISSUE_Master.CY ='" & strCY.Trim & "';"
            ElseIf strCheck = "Edit" Then
                strSql = "SELECT JW_ISSUE_DET.FID, FGMaster.FGName, JW_ISSUE_DET.QTY as [Issue QTY],JW_ISSUE_DET.Batch_No as [Batch No], JW_Ret_Det.Ret_Qty as [Ret QTY] " _
                    & " FROM (((JW_ISSUE_Master INNER JOIN JW_ISSUE_DET ON JW_ISSUE_Master.JID = JW_ISSUE_DET.JID) INNER JOIN " _
                    & " FGMaster ON JW_ISSUE_DET.FID = FGMaster.FID) INNER JOIN JW_Ret_Master ON JW_ISSUE_Master.JWID = JW_Ret_Master.JW_Issue_ID) " _
                    & " INNER JOIN JW_Ret_Det ON (FGMaster.FID = JW_Ret_Det.FID) AND (JW_Ret_Master.ID = JW_Ret_Det.ID) " _
                    & " WHERE (((JW_ISSUE_Master.JWID)='" & cmbJWID.Text & "')) and JW_ISSUE_Master.CY ='" & strCY.Trim & "';"
            End If
            dt.Rows.Clear()
            Dim adpt As New OleDb.OleDbDataAdapter(strSql, conn)
            adpt.Fill(dt)
            grdJB.DataSource = dt
            gvJB.Columns("FID").VisibleIndex = -1
        Catch ex As Exception
            If show_error Then
                MessageBox.Show(ex.ToString)
            End If
        End Try
    End Sub

    Private Sub gvJB_CustomRowCellEdit(ByVal sender As Object, ByVal e As DevExpress.XtraGrid.Views.Grid.CustomRowCellEditEventArgs) Handles gvJB.CustomRowCellEdit
        Try
            If e.Column.FieldName = "Rec QTY" Or e.Column.FieldName = "Rate" Then
                gvJB.Columns("Rec QTY").OptionsColumn.AllowEdit = True
            Else
                gvJB.Columns(e.Column.FieldName).OptionsColumn.AllowEdit = False
            End If
        Catch ex As Exception
            If show_error Then
                MessageBox.Show(ex.ToString)
            End If
        End Try
    End Sub

    Private Sub gvJB_CellValueChanging(ByVal sender As Object, ByVal e As DevExpress.XtraGrid.Views.Base.CellValueChangedEventArgs) Handles gvJB.CellValueChanging
       
    End Sub

    Private Sub gvJB_CellValueChanged(ByVal sender As Object, ByVal e As DevExpress.XtraGrid.Views.Base.CellValueChangedEventArgs) Handles gvJB.CellValueChanged
        Try
            If e.Value.ToString <> "" Then
                If e.Value > gvJB.GetRowCellValue(gvJB.FocusedRowHandle, "Issue QTY") Then
                    MessageBox.Show("Return qty can not be more then issue qty.", "Return Qty", MessageBoxButtons.OK, MessageBoxIcon.Information)
                End If
            End If
        Catch ex As Exception
            If show_error Then
                MessageBox.Show(ex.ToString)
            End If
        End Try
    End Sub

    Private Sub cmdReport_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmdReport.Click
        Try
            Dim mypara As New frmPara
            mypara.showDemoRet(txtJBRetID.Text.Trim)
            mypara.Dispose()
        Catch ex As Exception
            If show_error Then
                MessageBox.Show(ex.ToString)
            End If
        End Try
    End Sub
End Class

